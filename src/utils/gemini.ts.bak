"use server";
import "server-only";

type AnyClient = any;

function tryRequire(name: string): AnyClient | null {
  try {
    // eslint-disable-next-line @typescript-eslint/no-var-requires, @typescript-eslint/no-unsafe-return
    return require(name);
  } catch {
    return null;
  }
}

function resolveClient(pkg: AnyClient): AnyClient | null {
  if (!pkg) return null;
  if (pkg?.GoogleGenerativeAI) return pkg.GoogleGenerativeAI;
  if (pkg?.GoogleGenAI) return pkg.GoogleGenAI;
  if (pkg?.default) return pkg.default;
  return pkg;
}

/**
 * Retorna o cliente Gemini/GenAI disponível no runtime.
 * Tenta primeiro '@google/generative-ai' (novo SDK) e então '@google/genai' (legado).
 */
export function getGeminiClient(): AnyClient {
  const pkgNew = tryRequire("@google/generative-ai");
  const pkgOld = tryRequire("@google/genai");

  const resolvedNew = resolveClient(pkgNew);
  if (resolvedNew) return resolvedNew;

  const resolvedOld = resolveClient(pkgOld);
  if (resolvedOld) return resolvedOld;

  throw new Error(
    "Nenhum cliente Gemini/GenAI disponível. Instale @google/generative-ai ou @google/genai"
  );
}

/**
 * Adaptador mínimo para chamar a operação de geração no cliente.
 * Tenta várias formas conhecidas de SDK para maximizar compatibilidade.
 */
export async function generateWithGemini(client: AnyClient, opts: any) {
  if (!client) throw new Error("Cliente Gemini não inicializado");

  // Padrões conhecidos entre SDKs:
  if (typeof client.models?.generateContent === "function") {
    return client.models.generateContent(opts);
  }
  if (typeof client.generateContent === "function") {
    return client.generateContent(opts);
  }
  if (typeof client.generate === "function") {
    return client.generate(opts);
  }
  if (typeof client.generateText === "function") {
    return client.generateText(opts);
  }
  if (typeof client.text?.generate === "function") {
    return client.text.generate(opts);
  }

  // fallback: se o pacote exporta a função direta
  if (typeof client === "function") {
    return client(opts);
  }

  throw new Error("Método de geração não encontrado no cliente Gemini");
}
